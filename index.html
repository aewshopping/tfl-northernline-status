<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000001">
    <title>Northern Line Tracker</title>
    <style>
        body { background-color: #000; color: #fff; font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 500px; }
        header { border-bottom: 5px solid #efc100; margin-bottom: 20px; padding-bottom: 10px; }
        .line-badge { border: 2px solid #fff; display: inline-block; padding: 2px 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        
        .status-bar { display: flex; justify-content: space-between; align-items: baseline; margin-top: 8px; }
        #status-text { font-size: 1.1rem; font-weight: bold; }
        .crowding-container { text-align: right; }
        #crowding-text { font-size: 0.9rem; color: #aaa; text-transform: uppercase; }
        #crowding-source { font-size: 0.75rem; color: #666; font-style: italic; margin-top: 2px; }

        .status-good { color: #00ff00; }
        .status-bad { color: #ff4500; }

        #disruption-detail { 
            background: #221111; border: 1px solid #ff4500; padding: 12px; 
            margin: 15px 0; font-size: 0.9rem; line-height: 1.4; display: none; border-radius: 4px;
        }
        
        .controls { margin: 20px 0; background: #111; padding: 15px; border-radius: 8px; }
        select { width: 100%; padding: 12px; background: #222; color: #fff; border: 1px solid #444; font-size: 1rem; border-radius: 4px; outline: none; }
        
        .arrival-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #222; }
        .train-info { display: flex; flex-direction: column; }
        .branch-info { font-size: 0.85rem; color: #efc100; margin-top: 4px; text-transform: uppercase; font-weight: 500; }
        .time { color: #efc100; font-weight: bold; font-size: 1.3rem; }
        
        footer { margin-top: 30px; font-size: 1rem; color: #444; text-align: center; }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="line-badge">Northern</div>
            <h1>Line Status</h1>
            <div class="status-bar">
                <div id="status-text">Connecting...</div>
                <div class="crowding-container">
                    <div id="crowding-text">Crowding: --</div>
                    <div id="crowding-source">--</div>
                </div>
            </div>
            <div id="disruption-detail"></div>
        </header>

        <div class="controls">
            <select id="station-select">
                <option value="940GZZLUCSD|Northbound">Colliers Wood (Northbound)</option>
                <option value="940GZZLUMGT|Southbound">Moorgate (Southbound)</option>
            </select>
        </div>

        <div id="arrivals-list"></div>
        <footer>Updated: <span id="update-time">-</span></footer>
    </div>

    <script>
        const select = document.getElementById('station-select');
        const statusEl = document.getElementById('status-text');
        const crowdingEl = document.getElementById('crowding-text');
        const crowdingSourceEl = document.getElementById('crowding-source');
        const listEl = document.getElementById('arrivals-list');
        const disruptionEl = document.getElementById('disruption-detail');
        const timeEl = document.getElementById('update-time');

        function getBranch(train) {
            const search = [train.towards, train.destinationName, train.platformName, train.currentLocation]
                .join(" ").toLowerCase();
            if (search.includes("via bank")) return "via Bank";
            if (search.includes("via charing") || search.includes("via cx")) return "via Charing X";
            return ""; 
        }

        /**
         * Attempts multiple methods to get crowding data from TfL API.
         * 
         * IMPORTANT: percentageOfBaseline is returned as a FRACTION (0-1 scale), not 0-100.
         * So 0.18885 = 18.885%, not 0.18885%
         * 
         * It represents "a fraction of the busiest the station has been since July 2019"
         * - 1.0 (100%) = the absolute busiest it's EVER been
         * - 0.20-0.30 (20-30%) might be a typical busy rush hour
         * - 0.05-0.15 (5-15%) could be normal off-peak
         * - <0.05 (<5%) is very quiet
         * 
         * Returns an object with { level: string, source: string }
         */
        async function getLiveCrowding(stopId) {
            // Method 1: Try the /crowding/{naptan}/Live endpoint
            try {
                const response = await fetch(`https://api.tfl.gov.uk/crowding/${stopId}/Live`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Crowding Live data:', data);
                    
                    // Check if we have valid data
                    if (data && typeof data.percentageOfBaseline === 'number') {
                        const fraction = data.percentageOfBaseline;
                        const percentage = fraction * 100; // Convert 0-1 scale to percentage
                        let level;
                        
                        // Adjusted thresholds - percentageOfBaseline is of historic PEAK, not normal capacity
                        if (percentage < 5) level = "Very Quiet";
                        else if (percentage < 15) level = "Quiet";
                        else if (percentage < 30) level = "Moderate";
                        else if (percentage < 50) level = "Busy";
                        else if (percentage < 70) level = "Very Busy";
                        else level = "Exceptionally Busy";
                        
                        return { 
                            level, 
                            source: `Live: ${percentage.toFixed(1)}% of historic peak`,
                            timestamp: data.timeStamp || 'unknown'
                        };
                    }
                    
                    // Check dataAvailable flag
                    if (data && data.dataAvailable === false) {
                        console.log('Crowding data marked as unavailable');
                        return { 
                            level: "Not Available", 
                            source: "Live endpoint - no data" 
                        };
                    }
                }
            } catch (e) {
                console.log('Live crowding endpoint failed:', e);
            }

            // Method 2: Try /StopPoint/{naptan}/Crowding/northern for historical data
            try {
                const response = await fetch(`https://api.tfl.gov.uk/StopPoint/${stopId}/Crowding/northern`);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Historical crowding data:', data);
                    
                    // This endpoint returns passenger flow data by time slices
                    if (data && data.passengerFlows && data.passengerFlows.length > 0) {
                        const now = new Date();
                        const currentHour = now.getHours();
                        const currentMinutes = now.getMinutes();
                        
                        // Find the matching time slice (format like "0800-0815")
                        const timeString = `${String(currentHour).padStart(2, '0')}${String(Math.floor(currentMinutes/15)*15).padStart(2, '0')}`;
                        
                        const flow = data.passengerFlows.find(f => {
                            const [start] = f.timeSlice.split('-');
                            return start === timeString;
                        });
                        
                        if (flow && typeof flow.value === 'number') {
                            let level;
                            // Passenger flow value - these are relative/abstract units
                            if (flow.value < 5) level = "Very Quiet";
                            else if (flow.value < 10) level = "Quiet";
                            else if (flow.value < 20) level = "Moderate";
                            else if (flow.value < 30) level = "Busy";
                            else level = "Very Busy";
                            
                            return { 
                                level, 
                                source: `Historical: ${flow.timeSlice}, flow ${flow.value}` 
                            };
                        }
                        
                        // If we can't find current time but have data
                        return { 
                            level: "See Console", 
                            source: `Historical: ${data.passengerFlows.length} time slices available` 
                        };
                    }
                }
            } catch (e) {
                console.log('Historical crowding endpoint failed:', e);
            }

            // Method 3: All methods failed
            return { 
                level: "Not Available", 
                source: "No data from any endpoint" 
            };
        }

        function renderArrival(train) {
            const minutes = Math.floor(train.timeToStation / 60);
            return `
                <div class="arrival-item">
                    <div class="train-info">
                        <span>${train.destinationName}</span>
                        <span class="branch-info">${getBranch(train)}</span>
                    </div>
                    <span class="time">${minutes <= 0 ? "Due" : minutes + "m"}</span>
                </div>`;
        }

        async function update() {
            const [id, platformKey] = select.value.split('|');
            try {
                // Fetch line status and arrivals in parallel
                const [sRes, aRes] = await Promise.all([
                    fetch('https://api.tfl.gov.uk/Line/northern/Status'),
                    fetch(`https://api.tfl.gov.uk/StopPoint/${id}/Arrivals`)
                ]);

                const [sData, aData] = await Promise.all([
                    sRes.json(), aRes.json()
                ]);

                // Update Line Status
                const statusObj = sData[0].lineStatuses[0];
                const desc = statusObj.statusSeverityDescription;
                statusEl.innerText = `● ${desc}`;
                statusEl.className = desc === "Good Service" ? "status-good" : "status-bad";

                const hasDisruption = desc !== "Good Service" && statusObj.reason;
                disruptionEl.innerText = hasDisruption ? statusObj.reason : "";
                disruptionEl.style.display = hasDisruption ? "block" : "none";

                // Update Live Crowding - try multiple methods
                const crowdingData = await getLiveCrowding(id);
                crowdingEl.innerText = `Crowding: ${crowdingData.level}`;
                crowdingSourceEl.innerText = crowdingData.source;

                // Update Arrivals
                const filtered = aData
                    .filter(t => t.platformName.toLowerCase().includes(platformKey.toLowerCase()))
                    .sort((a, b) => a.timeToStation - b.timeToStation)
                    .slice(0, 5);

                listEl.innerHTML = filtered.length > 0 
                    ? filtered.map(renderArrival).join('') 
                    : '<p style="color:#666">No trains scheduled.</p>';

                timeEl.innerText = new Date().toLocaleTimeString();
            } catch (e) {
                console.error("Update error:", e);
                statusEl.innerText = "● Error";
                crowdingEl.innerText = "Crowding: --";
                crowdingSourceEl.innerText = "--";
            }
        }

        select.addEventListener('change', update);
        update();
        setInterval(update, 30000);
    </script>
</body>
</html>
